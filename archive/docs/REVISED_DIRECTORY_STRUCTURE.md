# Directory Structure Migration Guide

**MIGRATION COMPLETE** - This document describes the new standard structure.

## Key Insights from Official Guide

Based on the **Teracloud Streams Toolkit Development Guide**, I've revised the proposed structure to align with official standards:

### **Required Components (Per Guide)**
- `toolkit.xml` - Generated toolkit index (required for indexed toolkits)
- `info.xml` - Toolkit information model (optional but **strongly recommended**)

### **Standard Directory Structure (Per Guide)**
```
$toolkit_root/
├── info.xml              # Toolkit metadata (recommended)
├── toolkit.xml           # Generated toolkit index (required)
├── opt/                  # Optional components  
├── etc/                  # Configuration files
├── lib/                  # Support libraries
├── impl/                 # Implementation directory
│   ├── bin/              # Implementation binaries/scripts
│   ├── java/             # Java implementation (if needed)
│   │   ├── lib/          # Java libraries
│   │   └── bin/          # Java binaries
│   ├── lib/              # Platform-specific libraries
│   │   ├── x86_64.RHEL8/ # Platform-specific organization
│   │   └── x86_64.RHEL9/
│   ├── include/          # Header files
│   └── nl/               # Localization resources
├── samples/              # Sample applications (optional)
├── doc/                  # Documentation (optional)
└── [namespace]/          # Toolkit namespace directory
    └── *.spl files       # SPL operators
```

## **Revised Cleanup Plan for STT Toolkit**

Based on the official guide, here's how we should reorganize:

### **1. Keep in Standard Locations (Per Guide)**

#### **Root Level (Required/Recommended)**
```bash
# KEEP - Required by Streams
toolkit.xml                    # Generated by spl-make-toolkit
info.xml                      # Toolkit metadata
Makefile                      # Build configuration

# KEEP - Standard toolkit directories
com.teracloud.streamsx.stt/   # SPL operators namespace
samples/                      # Sample applications
```

#### **Configuration and Libraries (Standard Locations)**
```bash
# MOVE TO etc/ - Configuration files go here per guide
mv *.txt etc/                 # Move config files like current_models_inventory.txt
mv requirements*.txt etc/     # Move Python requirements

# MOVE TO lib/ - Runtime libraries per guide  
mv deps/ lib/                 # ONNX Runtime and other runtime deps

# KEEP impl/ - Implementation directory per guide
impl/                         # C++ implementation (already correct)
```

#### **Optional Components**
```bash
# MOVE TO opt/ - Supporting files per guide
mkdir -p opt/models
mv models/ opt/               # Model files are optional runtime components

# MOVE TO opt/ - Test data
mkdir -p opt/test_data  
mv archive/dev/opt/test_data/ opt/test_data/  # Move test audio files
```

### **2. Implementation Directory (Per Guide Standards)**

The `impl/` directory should follow the guide's structure:

```bash
impl/
├── bin/                      # MOVE utility scripts here
│   ├── setup_onnx_runtime.sh
│   ├── setup_kaldi_fbank.sh  
│   └── download_models.sh
├── lib/                      # Platform-specific libraries (already correct)
│   └── x86_64.RHEL*/
├── include/                  # Header files (already correct)
└── src/                      # Source files (already correct)
```

### **3. Python Utilities (Non-Standard - Toolkit Extension)**

Since Python utilities aren't covered in the guide, we can organize them under `opt/`:

```bash
opt/
├── python/                   # Python utilities
│   ├── export/              # Model export scripts
│   │   ├── export_model_ctc_patched.py  # MAIN working script
│   │   ├── export_model_ctc.py
│   │   └── ...other export variants
│   ├── download/            # Download utilities  
│   │   ├── download_nemo_cache_aware_conformer.py
│   │   └── download_nemo_simple.py
│   └── analysis/            # Debug/analysis tools
│       ├── check_*.py
│       ├── extract_*.py
│       └── validate_*.py
├── models/                  # Model files
└── test_data/              # Test audio and reference data
```

### **4. Application Bundle Considerations**

Per the guide, these directories are included in application bundles by default:
- `/lib` ✅ (our runtime libraries)
- `/etc` ✅ (our configuration files)  
- `/opt` ✅ (our models and utilities)
- `/impl/bin` ✅ (our utility scripts)
- `/impl/lib` ✅ (our platform libraries)

## **Migration Script (Standards-Compliant)**

```bash
#!/bin/bash
# migrate_to_streams_standard.sh

echo "Migrating to Teracloud Streams standard structure..."

# 1. Create standard directories
mkdir -p etc opt/{models,python/{export,download,analysis},test_data}
mkdir -p impl/bin

# 2. Move configuration files to etc/
echo "Moving configuration files to etc/..."
mv requirements*.txt etc/ 2>/dev/null || true
mv current_models_inventory.txt etc/ 2>/dev/null || true

# 3. Move runtime dependencies to lib/
echo "Moving runtime dependencies to lib/..."
mv deps/ lib/ 2>/dev/null || true

# 4. Move models to opt/
echo "Moving models to opt/..."
mv models/ opt/ 2>/dev/null || true

# 5. Move utility scripts to impl/bin/
echo "Moving utility scripts to impl/bin/..."
mv setup_*.sh impl/bin/ 2>/dev/null || true
mv download_models.sh impl/bin/ 2>/dev/null || true

# 6. Organize Python utilities in opt/
echo "Organizing Python utilities..."
mv export_*.py opt/python/export/ 2>/dev/null || true
mv download_*.py opt/python/download/ 2>/dev/null || true
mv check_*.py extract_*.py validate_*.py save_*.py opt/python/analysis/ 2>/dev/null || true
mv create_*.py find_*.py fix_*.py inspect_*.py opt/python/analysis/ 2>/dev/null || true

# 7. Move test data to opt/
echo "Moving test data..."
if [ -d "archive/dev/test_data" ]; then
    mv archive/dev/opt/test_data/* opt/test_data/ 2>/dev/null || true
fi

# 8. Clean up debug artifacts to .gitignore location
echo "Cleaning debug artifacts..."
mkdir -p .work/debug
mv *.bin *.npy python_debug_info.json .work/debug/ 2>/dev/null || true
mv venv_* .work/ 2>/dev/null || true

# 9. Update .gitignore
echo "Updating .gitignore..."
cat >> .gitignore << 'EOF'

# Working directory (Streams toolkit standard)
.work/
*.bin
*.npy
*_transcript_*.txt

# Virtual environments
venv*/

# Build artifacts
output/
data/
EOF

echo "Migration complete! Structure now follows Teracloud Streams standards."
```

## **Benefits of Standards-Compliant Structure**

### **✅ Compliance with Official Guide**
- Follows exact directory structure from Teracloud Streams documentation
- Uses standard locations that Streams tooling expects
- Proper application bundle inclusion automatically

### **✅ Runtime Compatibility**  
- `/lib` and `/impl/lib` for runtime libraries (included in bundles)
- `/etc` for configuration files (included in bundles)
- `/opt` for optional components (included in bundles)
- `/impl/bin` for utility scripts (included in bundles)

### **✅ Development Workflow**
- Python utilities in `/opt/python` (non-standard but logical)
- Models in `/opt/models` (optional runtime components)
- Clean separation of development vs runtime artifacts

### **✅ User Experience**
- **Primary export script**: `opt/python/export/export_model_ctc_patched.py`
- **Setup utilities**: `impl/bin/setup_onnx_runtime.sh`
- **Model files**: `opt/opt/models/fastconformer_ctc_export/`
- **Configuration**: `etc/requirements.txt`

## **Quick Start Commands (Post-Migration)**

```bash
# Setup environment
./impl/bin/setup_onnx_runtime.sh

# Export model
python opt/python/export/export_model_ctc_patched.py

# Build toolkit  
make clean && make

# Run tests
cd test && ./verify_nemo_setup.sh
```

This structure follows Teracloud Streams best practices while maintaining clear organization for our C++ toolkit with Python utilities.